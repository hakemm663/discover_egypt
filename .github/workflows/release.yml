name: Flutter Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      deploy_play_store:
        description: "Deploy Android artifact to Play Store"
        required: false
        type: boolean
        default: false
      deploy_app_store:
        description: "Deploy iOS build to App Store"
        required: false
        type: boolean
        default: false

concurrency:
  group: flutter-release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: 3.24.3

jobs:
  build_android_release:
    name: Build Android release artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: flutter pub get

      - name: Build app bundle
        run: flutter build appbundle --release

      - name: Build APK
        run: flutter build apk --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk

  build_ios_release:
    name: Build iOS release artifact
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-artifacts
          path: build/ios/iphoneos/

  build_web_release:
    name: Build web release artifact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-release-artifacts
          path: build/web/

  deploy_play_store:
    name: Optional Play Store deploy gate
    runs-on: ubuntu-latest
    needs: build_android_release
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_play_store) || (github.event_name == 'push' && vars.ENABLE_PLAY_STORE_DEPLOY == 'true') }}
    environment: play-store

    steps:
      - name: Deployment gate
        run: |
          echo "Play Store deployment gate enabled."
          echo "Configure release automation (for example fastlane supply) using protected environment secrets."

  deploy_app_store:
    name: Optional App Store deploy gate
    runs-on: macos-latest
    needs: build_ios_release
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_app_store) || (github.event_name == 'push' && vars.ENABLE_APP_STORE_DEPLOY == 'true') }}
    environment: app-store

    steps:
      - name: Deployment gate
        run: |
          echo "App Store deployment gate enabled."
          echo "Configure release automation (for example fastlane deliver) using protected environment secrets."
