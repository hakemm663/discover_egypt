name: Flutter Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Target runtime environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: prod
      deploy_play_store:
        description: "Deploy Android artifact to Play Store internal track"
        required: false
        type: boolean
        default: false
      deploy_app_store:
        description: "Deploy iOS build to App Store Connect"
        required: false
        type: boolean
        default: false

concurrency:
  group: flutter-release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: 3.24.3

jobs:
  build_android_release:
    name: Build Android (${{ matrix.app_env }})
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'push' || matrix.app_env == 'prod' }}
    strategy:
      fail-fast: false
      matrix:
        app_env: [dev, staging, prod]
    environment: ${{ matrix.app_env }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare runtime defines
        env:
          APP_ENV: ${{ matrix.app_env }}
          BASE_URL: ${{ vars.BASE_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          ENABLE_GOOGLE_AUTH: ${{ vars.ENABLE_GOOGLE_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          ENABLE_FACEBOOK_AUTH: ${{ vars.ENABLE_FACEBOOK_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          DISCOVERY_FALLBACK_ENABLED: ${{ vars.DISCOVERY_FALLBACK_ENABLED || vars.ENABLE_FALLBACK_CONTENT || 'true' }}
        run: |
          echo "MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}" >> "$GITHUB_ENV"
          {
            echo "DART_DEFINES<<EOF"
            echo "--dart-define=APP_ENV=${APP_ENV}"
            echo "--dart-define=BASE_URL=${BASE_URL}"
            echo "--dart-define=STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}"
            echo "--dart-define=GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}"
            echo "--dart-define=ENABLE_GOOGLE_AUTH=${ENABLE_GOOGLE_AUTH}"
            echo "--dart-define=ENABLE_FACEBOOK_AUTH=${ENABLE_FACEBOOK_AUTH}"
            echo "--dart-define=DISCOVERY_FALLBACK_ENABLED=${DISCOVERY_FALLBACK_ENABLED}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Configure Android signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ] || [ -z "$ANDROID_KEYSTORE_PASSWORD" ] || [ -z "$ANDROID_KEY_ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ]; then
            echo "Missing one or more Android signing secrets." >&2
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=app/upload-keystore.jks
          EOF

      - name: Build app bundle
        run: flutter build appbundle --release $DART_DEFINES

      - name: Build APK
        run: flutter build apk --release $DART_DEFINES

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ matrix.app_env }}
          if-no-files-found: error
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/mapping/release/mapping.txt

  build_ios_release:
    name: Build iOS (${{ matrix.app_env }})
    runs-on: macos-latest
    if: ${{ github.event_name != 'push' || matrix.app_env == 'prod' }}
    strategy:
      fail-fast: false
      matrix:
        app_env: [dev, staging, prod]
    environment: ${{ matrix.app_env }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare runtime defines
        env:
          APP_ENV: ${{ matrix.app_env }}
          BASE_URL: ${{ vars.BASE_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          ENABLE_GOOGLE_AUTH: ${{ vars.ENABLE_GOOGLE_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          ENABLE_FACEBOOK_AUTH: ${{ vars.ENABLE_FACEBOOK_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          DISCOVERY_FALLBACK_ENABLED: ${{ vars.DISCOVERY_FALLBACK_ENABLED || vars.ENABLE_FALLBACK_CONTENT || 'true' }}
        run: |
          {
            echo "DART_DEFINES<<EOF"
            echo "--dart-define=APP_ENV=${APP_ENV}"
            echo "--dart-define=BASE_URL=${BASE_URL}"
            echo "--dart-define=STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}"
            echo "--dart-define=GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}"
            echo "--dart-define=ENABLE_GOOGLE_AUTH=${ENABLE_GOOGLE_AUTH}"
            echo "--dart-define=ENABLE_FACEBOOK_AUTH=${ENABLE_FACEBOOK_AUTH}"
            echo "--dart-define=DISCOVERY_FALLBACK_ENABLED=${DISCOVERY_FALLBACK_ENABLED}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Install signing certificate and profile
        env:
          IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$IOS_DIST_CERT_BASE64" ] || [ -z "$IOS_DIST_CERT_PASSWORD" ] || [ -z "$IOS_PROVISION_PROFILE_BASE64" ] || [ -z "$KEYCHAIN_PASSWORD" ]; then
            echo "Missing iOS signing secrets." >&2
            exit 1
          fi
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          echo "$IOS_DIST_CERT_BASE64" | base64 --decode > ios_dist.p12
          security import ios_dist.p12 -k build.keychain -P "$IOS_DIST_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/app.mobileprovision"

      - name: Build signed IPA
        run: flutter build ipa --release --export-method app-store $DART_DEFINES

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-${{ matrix.app_env }}
          if-no-files-found: error
          path: |
            build/ios/ipa/*.ipa
            build/ios/archive/*.xcarchive

  build_web_release:
    name: Build web (${{ matrix.app_env }})
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'push' || matrix.app_env == 'prod' }}
    strategy:
      fail-fast: false
      matrix:
        app_env: [dev, staging, prod]
    environment: ${{ matrix.app_env }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.18.0
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare runtime defines
        env:
          APP_ENV: ${{ matrix.app_env }}
          BASE_URL: ${{ vars.BASE_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          ENABLE_GOOGLE_AUTH: ${{ vars.ENABLE_GOOGLE_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          ENABLE_FACEBOOK_AUTH: ${{ vars.ENABLE_FACEBOOK_AUTH || vars.ENABLE_SOCIAL_LOGIN || 'false' }}
          DISCOVERY_FALLBACK_ENABLED: ${{ vars.DISCOVERY_FALLBACK_ENABLED || vars.ENABLE_FALLBACK_CONTENT || 'true' }}
        run: |
          {
            echo "DART_DEFINES<<EOF"
            echo "--dart-define=APP_ENV=${APP_ENV}"
            echo "--dart-define=BASE_URL=${BASE_URL}"
            echo "--dart-define=STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}"
            echo "--dart-define=GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}"
            echo "--dart-define=ENABLE_GOOGLE_AUTH=${ENABLE_GOOGLE_AUTH}"
            echo "--dart-define=ENABLE_FACEBOOK_AUTH=${ENABLE_FACEBOOK_AUTH}"
            echo "--dart-define=DISCOVERY_FALLBACK_ENABLED=${DISCOVERY_FALLBACK_ENABLED}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Build web
        run: flutter build web --release $DART_DEFINES

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-release-${{ matrix.app_env }}
          path: build/web/

  deploy_play_store:
    name: Deploy Android to Play internal
    runs-on: ubuntu-latest
    needs: build_android_release
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_play_store) || (github.event_name == 'push' && vars.ENABLE_PLAY_STORE_DEPLOY == 'true') }}
    environment: play-store

    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-release-${{ github.event_name == 'workflow_dispatch' && inputs.target_environment || 'prod' }}
          path: dist/android

      - name: Upload to Play internal track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ vars.ANDROID_APPLICATION_ID }}
          releaseFiles: dist/android/*.aab
          mappingFile: dist/android/mapping.txt
          track: internal
          status: completed

      - name: Manual fallback gate
        if: ${{ always() && (secrets.PLAY_SERVICE_ACCOUNT_JSON == '' || vars.ANDROID_APPLICATION_ID == '') }}
        run: |
          echo "Play upload prerequisites are missing."
          echo "Required: PLAY_SERVICE_ACCOUNT_JSON secret and ANDROID_APPLICATION_ID variable in play-store environment."
          exit 1

  deploy_app_store:
    name: Upload iOS to App Store Connect
    runs-on: macos-latest
    needs: build_ios_release
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.deploy_app_store) || (github.event_name == 'push' && vars.ENABLE_APP_STORE_DEPLOY == 'true') }}
    environment: app-store

    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-release-${{ github.event_name == 'workflow_dispatch' && inputs.target_environment || 'prod' }}
          path: dist/ios

      - name: Upload signed IPA using App Store Connect API key
        env:
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
          ASC_API_PRIVATE_KEY_BASE64: ${{ secrets.ASC_API_PRIVATE_KEY_BASE64 }}
        run: |
          if [ -z "$ASC_API_KEY_ID" ] || [ -z "$ASC_API_ISSUER_ID" ] || [ -z "$ASC_API_PRIVATE_KEY_BASE64" ]; then
            echo "Missing App Store Connect API key secrets." >&2
            echo "Required: ASC_API_KEY_ID, ASC_API_ISSUER_ID, ASC_API_PRIVATE_KEY_BASE64" >&2
            exit 1
          fi

          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_API_PRIVATE_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${ASC_API_KEY_ID}.p8

          IPA_PATH=$(find dist/ios -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA found in downloaded artifact." >&2
            exit 1
          fi

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$ASC_API_KEY_ID" \
            --apiIssuer "$ASC_API_ISSUER_ID"
